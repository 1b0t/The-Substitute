// Generated by CoffeeScript 1.10.0
(function() {
  var cache, mediaFetchRequest, self, utils;

  mediaFetchRequest = require('../common/mediaFetchRequest');

  utils = require('../utils/utils');

  cache = require('../utils/cache');

  self = module.exports = {
    get: function(req, res, next) {
      mediaFetchRequest.get(req, res, next, mediaFetchRequest.mediaType.Shows);
    },
    getMultiple: function(req, res, next) {
      var episodeIDs, fetchImageDataForEpisodeIDs, mediaType, season_number, trakt_id;
      console.log("test");
      mediaType = "episodes";
      season_number = req.params.season_number;
      trakt_id = req.params.trakt_id;
      if ((trakt_id != null) && (season_number != null)) {
        fetchImageDataForEpisodeIDs = function(ids, callback) {
          var fetchedDataForMedia, i, id, len, pendingRequests, result, results;
          pendingRequests = ids.length;
          result = [];
          fetchedDataForMedia = function(json) {
            pendingRequests -= 1;
            result.push(json);
            if (pendingRequests === 0) {
              cache.save(req.params[mediaType], JSON.stringify(result));
              return callback(result);
            }
          };
          results = [];
          for (i = 0, len = episodeIDs.length; i < len; i++) {
            id = episodeIDs[i];
            results.push(mediaFetchRequest.fetchImageDataForTraktID(trakt_id, mediaFetchRequest.mediaType.Shows, fetchedDataForMedia, season_number, id));
          }
          return results;
        };
        if (req.params[mediaType] != null) {
          episodeIDs = req.params[mediaType].split(',');
          if (episodeIDs.length > 0 && req.params[mediaType].length > 0) {
            cache.load("/show/" + trakt_id + "/seasons/" + season_number + "/episodes?episodes=" + req.params[mediaType], function(cachedData) {
              var json;
              if (cachedData != null) {
                json = JSON.parse(cachedData);
                if (json != null) {
                  res.send(json);
                  next();
                  return;
                }
              }
              return fetchImageDataForEpisodeIDs(episodeIDs, function(json) {
                res.send({
                  success: true,
                  data: json
                });
                return next();
              });
            });
          } else {
            res.status(400);
            res.send({
              success: false,
              message: "comma seperated list of seaons_ids or slugs named 'movies' is required"
            });
            next();
          }
        } else {
          res.status(400);
          res.send({
            success: false
          });
          next();
        }
      } else {
        res.send({
          success: false,
          message: "required parameter :trakt_id missing"
        });
        next();
      }
    }
  };

}).call(this);
